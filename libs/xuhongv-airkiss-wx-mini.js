var wxUdp=null,closeFlag=!1,successFlag=!1,local_port=1e4,router_port=1e4,ack_port=10001,target_address="255.255.255.255",airkiss_version="release-v1.0";function B(e,t,s){if(null==wxUdp)if(airkiss(e,t),null!=(wxUdp=wx.createUDPSocket())){if(wxUdp.bind(local_port)!=local_port)return s({ip:null,bssid:null,result:"the port is occupied",code:0}),wxUdp.offMessage(),wxUdp.close(),void(wxUdp=null);successFlag=closeFlag=!1;var l=0;wxUdp.onMessage(function(e){if(0<e.remoteInfo.size){let t=new Uint8Array(e.message);if(t.forEach((e,t)=>{e==mRandomChar&&l++}),5<=l){successFlag=!0;var o="";for(let e=1;e<t.length;e++)o+=t[e].toString(16);s({ip:e.remoteInfo.address,bssid:o,result:"success",code:1}),wxUdp.offMessage(),wxUdp.close(),wxUdp=null}}}),socketSend(0),cdn((new Date).getTime(),s)}else s({ip:null,bssid:null,result:"not support udp",code:0})}function cdn(e,t){if(!closeFlag&&!successFlag){if(55e3<(new Date).getTime()-e)return t({ip:null,bssid:null,result:"time out",code:2}),void close();setTimeout(()=>{cdn(e,t)},1e3)}}function socketSend(e){var t;closeFlag||successFlag||e!=mEncodedData.length&&(t=new ArrayBuffer(mEncodedData[e]),800<e&&e%2?wxUdp.send({address:target_address,port:ack_port,message:t}):wxUdp.send({address:target_address,port:router_port,message:t}),setTimeout(()=>{socketSend(++e)},4))}function close(){closeFlag=!0,null!=wxUdp&&(wxUdp.offMessage(),wxUdp.close(),wxUdp=null)}var mEncodedData=[],mRandomChar=0;function lp(){for(let e=0;e<50;++e)for(let e=1;e<=4;++e)ad(e)}function ad(e){mEncodedData.push(e)}function magicCode(e,t){e=utf8(e),t=e.length+t.length+1;let o=[];o[0]=0|t>>>4&15,0==o[0]&&(o[0]=8),o[1]=16|15&t;e=CRC8(e);o[2]=32|e>>>4&15,o[3]=48|15&e;for(let e=0;e<20;++e)for(let e=0;e<4;++e)ad(o[e])}function CRC8(e){let t=e.length,o=0,s=0;for(;0<t--;){let t=e[o++];for(let e=8;0!=e;e--){var l=255&s^255&t;l&=1,s=(255&s)>>>1,0!=l&&(s=255&s^140),t=(255&t)>>>1}}return 255&s}function pc(e){e=e.length;let t=[];t[0]=64|e>>>4&15,t[1]=80|15&e;e=CRC8([e]);t[2]=96|e>>>4&15,t[3]=112|15&e;for(let e=0;e<4;++e)ad(t[e])}function sp(e,t){let o=[];o[0]=255&e,o=o.concat(t),ad(128|CRC8(o)),ad(128|e),t.forEach((e,t)=>{ad(256|255&e)})}function airkiss(e,t){mEncodedData=[],mRandomChar=Math.floor(10*Math.random()+1);let o=5;var s=utf8(t),l=utf8(e);let n=[];n=n.concat(s),n=n.concat(mRandomChar),n=n.concat(l);for(var a=parseInt(n.length/4);0<o--;){lp(),magicCode(e,t);for(let e=0;e<15;++e){pc(t);for(let o=0;o<a;o++){let t=[];for(let e=4*o;e<4*(o+1);e++)t.push(n[e]);sp(o,t)}if(n.length%4!=0){let t=[];var r=n.length%4,c=4*a;for(let e=c;e<c+r;e++)t.push(n[e]);sp(a,t)}}}return mEncodedData}function utf8(o){const s=[];for(let t=0;t<o.length;t++){let e=o.charCodeAt(t);e<128?s.push(e):e<2048?s.push(192|e>>6,128|63&e):e<55296||57344<=e?s.push(224|e>>12,128|e>>6&63,128|63&e):(t++,e=65536+((1023&e)<<10|1023&o.charCodeAt(t)),s.push(240|e>>18,128|e>>12&63,128|e>>6&63,128|63&e))}for(let e=0;e<s.length;e++){var t=s[e];127<t&&(s[e]=t-256)}return s}module.exports={startConfig:B,version:airkiss_version,close:close};